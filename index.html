<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Area Bid Helper (Test Version)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <!-- Mapbox GL & Draw -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <!-- Geocoder (address search) -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css"/>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { position: absolute; inset: 0; }
    .panel {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: #fff; padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.18);
      min-width: 240px;
    }
    .panel .row { margin-top: 6px; }
    .panel button { margin-top: 6px; width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; background:#f8f8f8; cursor:pointer; }
    .panel button:hover { background:#f0f0f0; }
    .token-warning{ position:absolute; bottom:10px; left:10px; z-index:10; background:#fff3cd; color:#5c3c00; padding:8px 10px; border-radius:8px; border:1px solid #ffe69c; display:none; }
    .mapboxgl-ctrl-top-left { margin-top: 80px; } /* Push draw controls below geocoder */
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div id="output"><strong>Draw shapes</strong> then see total area & perimeter.</div>
    <div class="row"><button id="btn-poly">✏️ Polygon Mode</button></div>
    <div class="row"><button id="btn-rect">▭ Draw Rectangle</button></div>
    <div class="row"><button id="btn-freehand">~ Freehand Polygon</button></div>
    <div class="row"><button id="btn-circle">◯ Draw Circle</button></div>
    <div class="row"><button id="btn-image">Download Snapshot</button></div>
    <div class="row"><button id="btn-data">Download Data (JSON)</button></div>
  </div>
    <div class="row"><button id="btn-image">Download Snapshot</button></div>
    <div class="row"><button id="btn-data">Download Data (JSON)</button></div>
  </div>

  <div class="token-warning" id="tokenWarn">⚠️ Map token missing/blocked. Add a valid Mapbox token and allow your <em>.vercel.app</em> domain.</div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // 1) TOKEN: set your public token here (starts with "pk").
    //    For testing on Vercel, ensure the token's URL restrictions include your .vercel.app domain.
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2VhbG5zdHJpcGVuc3BlY2lhbGlzdCIsImEiOiJjbWZhYm5lNXgxNTh1MmtuMTB4ejV6M3dsIn0.xsRAPKrVTwtxgFzoWfyB5g';

    // Warn if token is not set
    if (!mapboxgl.accessToken || mapboxgl.accessToken.includes('pk.eyJ1Ijoic2VhbG5zdHJpcGVuc3BlY2lhbGlzdCIsImEiOiJjbWZhYm5lNXgxNTh1MmtuMTB4ejV6M3dsIn0.xsRAPKrVTwtxgFzoWfyB5g')) {
      document.getElementById('tokenWarn').style.display = 'block';
    }

    // 2) Create map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-streets-v12',
      center: [-98.5795, 39.8283], // USA center
      zoom: 4,
      preserveDrawingBuffer: true // improves snapshot reliability
    });

    // 3) Add Geocoder (address search)
    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      marker: false,
      placeholder: 'Search address or place'
    });
    map.addControl(geocoder, 'top-left');

    // 4) Draw controls
    const draw = new MapboxDraw({
      displayControlsDefault: false,
      controls: { polygon: true, trash: true },
      defaultMode: 'draw_polygon'
    });
    map.addControl(draw, 'top-left');

    // --- Drawing Modes & Helpers ---
    const setPolygonMode = () => {
      draw.changeMode('draw_polygon');
      document.getElementById('output').innerHTML = 'Polygon mode: click to add vertices, double-click to finish.';
    };

    document.getElementById('btn-poly').addEventListener('click', setPolygonMode);

    // Rectangle: pick two opposite corners
    document.getElementById('btn-rect').addEventListener('click', () => {
      document.getElementById('output').innerHTML = 'Rectangle: click first corner, then second corner.';
      let first = null;
      const onClick = (e) => {
        if (!first) {
          first = [e.lngLat.lng, e.lngLat.lat];
        } else {
          const second = [e.lngLat.lng, e.lngLat.lat];
          const minX = Math.min(first[0], second[0]);
          const maxX = Math.max(first[0], second[0]);
          const minY = Math.min(first[1], second[1]);
          const maxY = Math.max(first[1], second[1]);
          const rect = {
            type: 'Feature',
            properties: {},
            geometry: {
              type: 'Polygon',
              coordinates: [[
                [minX, minY], [maxX, minY], [maxX, maxY], [minX, maxY], [minX, minY]
              ]]
            }
          };
          draw.add(rect);
          map.off('click', onClick);
          first = null;
          updateMeasurements();
        }
      };
      map.off('click', onClick); // safety
      map.on('click', onClick);
    });

    // Freehand Polygon: press & hold to draw, release to finish
    let freehand = { active: false, points: [] };
    const finishFreehand = () => {
      if (!freehand.active || freehand.points.length < 3) return;
      // close polygon
      const coords = freehand.points.slice();
      coords.push(coords[0]);
      const poly = { type: 'Feature', properties: {}, geometry: { type: 'Polygon', coordinates: [coords] } };
      draw.add(poly);
      freehand.active = false; freehand.points = [];
      map.getCanvas().style.cursor = '';
      updateMeasurements();
    };

    document.getElementById('btn-freehand').addEventListener('click', () => {
      document.getElementById('output').innerHTML = 'Freehand: hold mouse button and move to draw; release to finish.';
      map.getCanvas().style.cursor = 'crosshair';
      freehand.active = false; freehand.points = [];
    });

    map.on('mousedown', (e) => {
      if (document.activeElement && document.activeElement.tagName === 'INPUT') return;
      // Start freehand only if the freehand button was the last intent
      if (document.getElementById('output').innerText.startsWith('Freehand')) {
        freehand.active = true;
        freehand.points = [[e.lngLat.lng, e.lngLat.lat]];
      }
    });

    map.on('mousemove', (e) => {
      if (!freehand.active) return;
      const last = freehand.points[freehand.points.length - 1];
      const curr = [e.lngLat.lng, e.lngLat.lat];
      // add point if moved enough (~2px)
      const dx = curr[0] - last[0];
      const dy = curr[1] - last[1];
      if (Math.abs(dx) > 0.00002 || Math.abs(dy) > 0.00002) {
        freehand.points.push(curr);
      }
    });

    map.on('mouseup', () => finishFreehand());

    // Circle button was added earlier; keep behavior
    document.getElementById('btn-circle').addEventListener('click', () => {
      document.getElementById('output').innerHTML = 'Click a point on the map for the circle center…';
      map.getCanvas().style.cursor = 'crosshair';
      map.once('click', (e) => {
        map.getCanvas().style.cursor = '';
        const center = [e.lngLat.lng, e.lngLat.lat];
        const input = prompt('Enter radius (feet):', '50');
        if (!input) { updateMeasurements(); return; }
        const radiusFeet = Number(input);
        if (Number.isNaN(radiusFeet) || radiusFeet <= 0) { alert('Please enter a positive number.'); return; }
        const radiusMiles = radiusFeet / 5280;
        const circle = turf.circle(center, radiusMiles, { steps: 128, units: 'miles' });
        draw.add(circle);
        updateMeasurements();
      });
    });

    map.on('draw.create', updateMeasurements);
    map.on('draw.update', updateMeasurements);
    map.on('draw.delete', () => {
      document.getElementById('output').innerHTML = '<strong>Draw shapes</strong> then see total area & perimeter.';
    });
    map.on('draw.update', updateMeasurements);
    map.on('draw.delete', () => {
      document.getElementById('output').innerHTML = '<strong>Draw a polygon</strong> to see area & perimeter (use the ✏️ control on the map).';
    });

    function updateMeasurements () {
      const data = draw.getAll();
      if (data.features.length) {
        const polygon = data.features[0];

        // Area comes in square meters; convert to square feet
        const areaSqMeters = turf.area(polygon);
        const areaSqFt = areaSqMeters * 10.76391041671;

        // Perimeter: use miles then convert to feet
        const perimeterMiles = turf.length(polygon, { units: 'miles' });
        const perimeterFeet = perimeterMiles * 5280;

        document.getElementById('output').innerHTML = `
          <div><strong>Area:</strong> ${areaSqFt.toFixed(2)} sq ft</div>
          <div><strong>Perimeter:</strong> ${perimeterFeet.toFixed(2)} ft</div>
        `;
      }
    }

    // 5) Snapshot
    document.getElementById('btn-image').addEventListener('click', () => {
      map.getCanvas().toBlob(blob => {
        if (!blob) return alert('Snapshot failed. Try again after map fully loads.');
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'area-snapshot.png';
        link.click();
      });
    });

    // 6) Data export
    document.getElementById('btn-data').addEventListener('click', () => {
      const data = draw.getAll();
      if (!data.features.length) return alert('Draw an area first.');

      const polygon = data.features[0];
      const areaSqFt = turf.area(polygon) * 10.76391041671;
      const perimeterFeet = turf.length(polygon, { units: 'miles' }) * 5280;

      const exportData = {
        area_sq_ft: Number(areaSqFt.toFixed(2)),
        perimeter_ft: Number(perimeterFeet.toFixed(2)),
        coordinates: polygon.geometry.coordinates
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'measurement-data.json';
      link.click();
    });
  </script>
</body>
</html>
